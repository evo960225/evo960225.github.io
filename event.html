<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Event</title>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
   <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script type="text/javascript" src="js/bootstrap.js"></script>
  <script type="text/javascript" src="js/eventJs.js"></script>

  <!--<script type="text/javascript" src="http://demonstration.abgne.tw/jquery/plugins/0082/js/jquery.bgiframe.js"></script>-->
  <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyAqZmBR0L326jweeAj84JiwM54stfvbOIE&signed_in=true&libraries=places"></script>
  <link rel="stylesheet" herf="text/css" href="eventCss.css">
  <!--<link rel="icon" href="img/favicon.png" type="image/ico" />-->
  <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">

  <script type="text/javascript" src="js/mix_main.js"></script>
  <script language="JavaScript" type="text/javascript">

    var CLIENT_ID = '1032454829565-mq9a352elo3m505k6eqmp79114brc1lp.apps.googleusercontent.com';
    var KEY = '2OTAi0eufTVRWhCrKB2wivpy';
    var SCOPES = ["https://www.googleapis.com/auth/calendar"];

    function resizeImage()
    {
      var window_height = document.body.clientHeight
      var window_width = document.body.clientWidth
      var image_width = document.images[0].width
      var image_height = document.images[0].height
      var height_ratio = image_height / window_height
      var width_ratio = image_width / window_width
      if (height_ratio > width_ratio)
      {
      document.images[0].style.width = "auto"
      document.images[0].style.height = "100%"
      }
      else
      {
      document.images[0].style.width = "100%"
      document.images[0].style.height = "auto"
      }
    }



	  function checkAuth() {
      //gapi.client.init({apiKey:'AIzaSyDMky4gQFhabfz4SoxuMkLAuIq2xpOy-WA'});
	    //gapi.client.setApiKey(KEY);
        gapi.auth.authorize(
          {
            'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          },loadCalendarApi);
      }

       /**
       * Load Google Calendar client library. List upcoming events
       * once client library is loaded.
       */
      function loadCalendarApi() {
        gapi.client.load('calendar', 'v3', listUpcomingEvents);
      }

      /**
       * Print the summary and start datetime/date of the next ten events in
       * the authorized user's calendar. If no events are found an
       * appropriate message is printed.
       */
      function listUpcomingEvents() {
        var request = gapi.client.calendar.events.list({
          'calendarId': 'primary',
          'timeMin': (new Date()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        });

        request.execute(function(resp) {
          var events = resp.items;
          //appendPre('Upcoming events:');
          if (events!=null && events.length > 0) {
            for (i = 0; i < events.length; i++) {
              var event = events[i];
              var when = event.start.dateTime;
              if (!when) {
                when = event.start.date;
              }
              $('#event_div #event_content').append(event.summary + ' (' + when + ')' +'<br/>');
              //appendPre(event.summary + ' (' + when + ')')
            }
          } else {
                 $('event_content').append("No upcoming events found");
               //appendPre('No upcoming events found.');
          }

        });
      }

      function appendPre(message) {
        var pre = document.getElementById('output');
        var textContent = document.createTextNode(message + '\n');
        pre.appendChild(textContent);
      }

      function deleteEvent() {
        alert('執行deleteEvent()');
          var eventName = document.getElementById("deleteName").value;
          alert(eventName);
          var eventstartdate = document.getElementById("deleteStartDate").value;
          alert(eventstartdate);
          var request = gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'maxResults': 10
              });
          request.execute(function(resp) {
            var id = -1;
            var it = resp.items;
            var i =0;
            for(i=0;i<it.length;i++){
              if(it[i].summary == eventName && (eventstartdate=="" || it[i].start.date == eventstartdate)){
                id = it[i].id;
              }

            }
            if(id!=-1){
              var deleteR = gapi.client.calendar.events.delete({
                'calendarId': 'primary',
                'eventId': id
              });
              deleteR.execute();
              alert('finish');
              myrefresh();
              cancelEvent('#deletetDiv');
            }
          });
      }


      function search(){
        alert('執行search');
        var request = gapi.client.calendar.events.list({
              'calendarId': 'primary',
              'timeMin': (new Date()).toISOString(),
              'showDeleted': false,
              'singleEvents': true,
              'maxResults': 10,
              'orderBy': 'startTime'
            });

            request.execute(function(resp) {
              var events = resp.items;
              var itDate = document.getElementById("searchDate").value;

                  if (events.length > 0) {
                    console.log("events.length>0");
                    for (i = 0; i < events.length; i++) {
                      var event = events[i];
                      //var when = event.start.dateTime;
                      var when = event.start.dateTime;
                      var sdate = when.substring(0,10);
                      if(itDate == sdate){
                      appendPre(event.summary + " " + sdate);
                      i = events.length + 1;
                      }else if (i == events.length-1){
                      appendPre("No event.");
                      }
                    }
                  }
        });
      }

      function insertEvent(){
        alert('執行insert function');
        var eventName = document.getElementById("insertName").value;
        var eventstartdate = document.getElementById("insertStartDate").value;
        var eventenddate = document.getElementById("insertEndDate").value;
        var eventlocation = document.getElementById("insertLocation");
        var event = {
          'summary': eventName,
          'location':eventlocation,
          'start': {
            'date': eventstartdate
          },
          'end': {
            'date': eventenddate
          }
        };

        var request = gapi.client.calendar.events.insert({
          'calendarId': 'primary',
          'resource': event
        });

        request.execute(function(event) {
          console.log(event);
          myrefresh();
        });

        cancelEvent('#insertDiv');

      }

      //重新導入畫面(刷新)
      function myrefresh() {
        window.location.reload();
      }

      function cancelEvent(div){
        alert(div);
        $(div).dialog('close');
      }

      function search(){
          var eventName = document.getElementsByClassName("eventName").value;
          var eventstartdate = document.getElementsByClassName("eventStartDate").value;
          var eventenddate = document.getElementsByClassName("eventEndDate").value;
          var eventLocation = document.getElementsByClassName("eventLocation").value;
          var request = gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
                'maxResults': 10,
                'orderBy': 'startTime'
              });

          request.execute(function(resp) {
                var events = resp.items;
            var itDate = document.getElementById("searchDate").value;

                if (events.length > 0) {
                  for (i = 0; i < events.length; i++) {
                    var event = events[i];
                    var when = event.start.dateTime;
              var when = event.start.date;
              if(itDate == when){
              appendPre(event.summary + " " + when);
              document.getElementsByClassName("eventName").value = event.summary;
              document.getElementsByClassName("eventEndDate").value=event.start.date;
              document.getElementsByClassName("eventStartDate").value =event.end.date;
              document.getElementsByClassName("eventLocation").value=event.location;
              i = events.length + 1;
              }else if (i == events.length-1){
              appendPre("Can't find the event");
              }
                  }
                }

          });

        }

      function signOut() {
        alert('觸發signout()');
        window.location.replace("https://accounts.google.com/logout");
        //window.location.replace("login.html");

      }

      function modify(){
    		var eventName = document.getElementById("eventName").value;
    		var eventstartdate = document.getElementById("eventStartDate").value;
    		var eventenddate = document.getElementById("eventEndDate").value;
    		var eventLocation = document.getElementById("eventLocation").value;
        var event = {
          'location':eventLocation,
          'start': {
          'date': eventstartdate
          },
          'end': {
          'date': eventenddate
          }
        };
    		var request = gapi.client.calendar.events.list({
              'calendarId': 'primary',
              'timeMin': (new Date()).toISOString(),
              'singleEvents': true,
              'maxResults': 10,
              'orderBy': 'startTime'
            });

    		request.execute(function(resp) {
              var events = resp.items;
    		      var i = 0;
              if (events.length > 0) {
                for (i = 0; i < events.length; i++) {
                  var event = events[i];
    			  if(eventName == event.summary){
    				var id = event.id;
    				event.summary = eventName;
    				event.start.date = eventstartdate;
    				event.end.date = eventenddate;
    				event.location = eventLocation;
    				i = events.length + 1;
          }
                }
              }
    		  var updateevent = gapi.client.calendar.events.update({
    				  'calendarId': 'primary',
    				  'eventId': id,
              'resource': event
    				});
    			updateevent.execute(function(event) {
      		  alert();
      		});
    		});

    	}

    </script>

    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>



</head>

<body>
  <div id="insertDiv" class="buttonDiv" title="編輯事件" style="position: relative; z-index: 99;">
    <p>
         <label for="insertName">事件名稱：</label>
         <input type="text" class="text" id="insertName" class="eventName required"  title="請輸入事件名稱" clientidmode="Static">
         <span class="star">*</span>
    </p>

    <p>
         <label for="insertStartDate">事件開始日期：</label>
         <input type="date" class="date" id="insertStartDate" class="eventStartDate" clientidmode="Static">
         <span class="star">*</span>
    </p>

     <p>
         <label for="insertEndDate">事件結束日期：</label>
         <input type="date" class="date" id="insertEndDate" class="eventEndDate" clientidmode="Static">
         <span class="star">*</span>
    </p>

    <p>
         <label for="insertLocation">事件地點：</label>
         <input type="text" class="text" id="insertLocation" class="eventLocation" clientidmode="Static">
         <span class="star">*</span>
    </p>

    <hr id="hr_line" color="#fff" size="3"/>
       <button type="button" class="btn btn-info btn-lm" class="cancel_button" style="float: right; margin:0px 3px"onclick="cancelEvent('#insertDiv')">取消</button>
      <button type="button" class="btn btn-info btn-lm" id="insert_button" style="float: right; margin:0px 3px" onclick="insertEvent()">提交</button>

  </div>


   <div id="deleteDiv" class="buttonDiv" title="編輯事件" style="position: relative; z-index: 99;">
      <p>
           <label for="deleteName">事件名稱：</label>
           <input type="text" class="text" id="deleteName" title="請輸入事件名稱" class="eventName" clientidmode="Static">
           <span class="star">*</span>
      </p>

      <p>
           <label for="deleteStartDate">事件開始日期：</label>
           <input type="date" class="date" id="deleteStartDate" class="eventStartDate" clientidmode="Static">
           <span class="star">*</span>
      </p>

      <hr id="hr_line" color="#fff" size="3"/>
         <button type="button" class="btn btn-info btn-lm" class="cancel_button" style="float: right; margin:0px 3px"onclick="cancelEvent('#deleteDiv')">取消</button>
        <button type="button" class="btn btn-info btn-lm" id="delete_button" style="float: right; margin:0px 3px" onclick="deleteEvent()">刪除</button>

    </div>










      <nav class="navbar navbar-inverse navbar-fixed-top" style="font-size:18px" >
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Guider</a>
          </div>

          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

            <ul class="nav navbar-nav">
              <li class="active"><a href="#">事件列表<span class="sr-only">(current)</span></a></li>
              <li><a href="map.html">地圖導航</a></li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
                  <li><a href="https://www.facebook.com/groups/747200725393872/"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>&nbsp;聯絡我們</a></li>
                  <li><a href="#" onclick="signOut()"><span class="glyphicon glyphicon-log-out" aria-hidden="true"></span>&nbsp;登出</a></li>

             </ul>


          </div>
      </nav>


  <div id="event_div" class="container-fluid">

            <div id="event_header">
                   Upcoming events:
            </div>
            <hr/>
            <div id="event_content">

            </div>
            <footer id="event_footer">
                <hr>
                <button type="button" class="btn btn-primary btn-lg" id="insert_button">新增事件</button>
                <button type="button" class="btn btn-primary btn-lg" id="delete_button">刪除事件</button>
                <button type="button" class="btn btn-primary btn-lg" id="edit_button">編輯事件</button>
           </footer>
  </div>



      <div id="search">
        <input type="date" id="searchDate" class="eventStartDate">
        <button id="button" class="btn btn-info" onclick="search()" > search </button>
        <pre id="output"></pre>
      </div>




      <script src="https://www.google-analytics.com/urchin.js" type="text/javascript">
      </script>

      <meta http-equiv="content-type" content="text/html charse=utf-8">
      <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">


  </body>

</html>
