<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>Event</title>
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script src="js/bootstrap-datetimepicker.min.js"></script>
  <script type="text/javascript" src="js/eventJs.js"></script>
  <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script type="text/javascript" src="js/bootstrap.js"></script>
  <!--<script type="text/javascript" src="http://demonstration.abgne.tw/jquery/plugins/0082/js/jquery.bgiframe.js"></script>-->
  <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyAqZmBR0L326jweeAj84JiwM54stfvbOIE&signed_in=true&libraries=places"></script>
  <link rel="stylesheet" herf="text/css" href="eventCss.css">
  <link rel="stylesheet" herf="text/css" href="css/bootstrap-datetimepicker.min.css">
  <!--<link rel="icon" href="img/favicon.png" type="image/ico" />-->
  <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">


  <script language="JavaScript" type="text/javascript">
    var CLIENT_ID = '1032454829565-mq9a352elo3m505k6eqmp79114brc1lp.apps.googleusercontent.com';
    var KEY = '2OTAi0eufTVRWhCrKB2wivpy';
    var SCOPES = ["https://www.googleapis.com/auth/calendar"];

    function resizeImage()
    {
      var window_height = document.body.clientHeight;
      var window_width = document.body.clientWidth;
      var image_width = document.images[0].width;
      var image_height = document.images[0].height;
      var height_ratio = image_height / window_height;
      var width_ratio = image_width / window_width;
      if (height_ratio > width_ratio)
      {
      document.images[0].style.width = "auto";
      document.images[0].style.height = "100%";
      }
      else
      {
      document.images[0].style.width = "100%";
      document.images[0].style.height = "auto";
      }
    }


    var directionsService;
    function initDestinationAuto(){
      directionsService = new google.maps.DirectionsService();  
      destination_autocomplete =  new google.maps.places.Autocomplete(document.getElementById('insertLocation'));
    }


	  function checkAuth() {
      //gapi.client.init({apiKey:'AIzaSyDMky4gQFhabfz4SoxuMkLAuIq2xpOy-WA'});
	    //gapi.client.setApiKey(KEY);
       gapi.auth.authorize(
         {
           'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          },loadCalendarApi);
       initDestinationAuto();

    }

     /**
     * Load Google Calendar client library. List upcoming events
     * once client library is loaded.
     */
    function loadCalendarApi() {
      gapi.client.load('calendar', 'v3', listUpcomingEvents);

    }

    /**
     * Print the summary and start datetime/date of the next ten events in
     * the authorized user's calendar. If no events are found an
     * appropriate message is printed.
     */
    function listUpcomingEvents() {
      var request = gapi.client.calendar.events.list({
        'calendarId': 'primary',
        'timeMin': (new Date()).toISOString(),
        'showDeleted': false,
        'singleEvents': true,
        'maxResults': 10,
        'orderBy': 'startTime'
      });
      showUserName();

      request.execute(function(resp) {
        $('#Event_content').html("");
        var events = resp.items;
        //$('#userName').html('&nbsp' + events.id);
        //appendPre('Upcoming events:');
        if (events!=null && events.length > 0) {
          for (i = 0; i < events.length; i++) {
            var event = events[i];
            var when = event.start.dateTime;
            if (!when) {
              when = event.start.date;
            }
            $('#event_content').append(event.summary + ' (' + when + ')' +'<br/>');
            //$('#userName').html('&nbsp' + event.organizer.displayName);
            //appendPre(event.summary + ' (' + when + ')')
            
          }
        } else {
               $('#event_content').append("No upcoming events found");
               //$('#userName').html('&nbsp' + event.organizer.displayName);
             //appendPre('No upcoming events found.');
        }

      });
    }

    /*function appendPre(message) {
      var pre = document.getElementById('output');
      var textContent = document.createTextNode(message + '\n');
      pre.appendChild(textContent);
    }*/

    /*刪除事件*/
    function deleteEvent(){
      alert('執行deleteEvent()');
        var eventName = document.getElementById("deleteName").value;
        var eventStartDate = document.getElementById("deleteStartDate").value;

        if((eventName == "") || (eventStartDate == "")){
            alert("Error!有未輸入的欄位");
           
        }else{
          var request = gapi.client.calendar.events.list({
                'calendarId': 'primary',
                'timeMin': (new Date()).toISOString(),
                'showDeleted': false,
                'singleEvents': true,
          });

          request.execute(function(resp) {
                var id = -1;
                var it = resp.items;
                var i =0;
                for(i=0;i<it.length;i++){
                  if((it[i].summary == eventName) && (it[i].start.date == eventStartDate)){
                    id = it[i].id;
                    break;
                  }
                }

                if(id!=-1){
                  ensureEvent();
                  $("#confirm_Ebutton").click(function(){
                    var deleteR = gapi.client.calendar.events.delete({
                        'calendarId': 'primary',
                        'eventId': id
                      });
                    deleteR.execute();
                    alert("刪除成功");
                    myrefresh();

                  });

                }else{
                  alert("找不到符合的資料");
                }
              });
          }

    }

    function ensureEvent(){
        $('#ensureDiv').dialog('open');
    }

    function insertEvent(){
      alert('執行insert function');
      var eventName = document.getElementById("insertName").value;
      var eventStartDate = document.getElementById("insertStartDate").value;
      var eventEndDate = document.getElementById("insertEndDate").value;
      var eventLocation = document.getElementById("insertLocation").value;
      
      //var dateTime = new Date(Date.now()).toISOString();
      //日期轉換(天數+1)
      var dd = parseInt(eventEndDate.substr(8,2))+1;
      var mm = parseInt(eventEndDate.substr(5,2));
      var yy = parseInt(eventEndDate.substr(0,4));
      var eventEndDate = (yy+'-'+mm+'-'+dd);


      if((eventName == "") || (eventStartDate == "")||(eventEndDate == "") || (eventLocation == "")){
        alert("Error!有未輸入的欄位");

      }else{
		if(eventStartDate < eventEndDate){
			 alert("Error!開始日期不得小於結束日期");
		}else{
			var event = {
			  'summary': eventName,
			  'location':eventLocation,
			  'start': {
				'date': eventStartDate,
			   
			  },
			  'end': {
				'date': eventEndDate,
			  }
			};

			var request = gapi.client.calendar.events.insert({
			  'calendarId': 'primary',
			  'resource': event,
			});

			request.execute(function(event) {
			  alert("新增成功");
			  console.log(event);
			  myrefresh();
			});

			cancelEvent('#insertDiv');
			}
		}
    };


    function locationCheck(location){
      var destination_autocomplete = new google.maps.places.Autocomplete(document.getElementById(location));
      google.maps.event.addListener(destination_autocomplete, 'place_changed', function() { 
        var place = destination_autocomplete.getPlace();
        if (!place.geometry) {
          return;
        }

      });
        
    }

    //重新導入畫面(刷新)
    function myrefresh() {
      window.location.reload();
    }

    /*取消事件*/
    function cancelEvent(div){
      $(div).dialog('close');
    }

    /*查詢事件*/
    function searchEvent(){
        var eventName = document.getElementById("searchName").value;
        var eventStartDate = document.getElementById("searchStartDate").value;
        if((eventName == "") || (eventStartDate == "")){
          alert("Error!有未輸入的欄位");

        }else{
            var request = gapi.client.calendar.events.list({
                  'calendarId': 'primary',
                  'timeMin': (new Date()).toISOString(),
                  'showDeleted': false,
                  'singleEvents': true,
                  'maxResults': 10,
                  'orderBy': 'startTime'
                });

            request.execute(function(resp) {
                var events = resp.items;
                var itDate = document.getElementById("searchStartDate").value;
                var itName = document.getElementById("searchName").value;
                if (events.length > 0) {
                  for (i = 0; i < events.length; i++) {
                    var event = events[i];
                    //var when = event.start.dateTime;
                    var when = event.start.date;
                    var name = event.summary;

                    if(itDate == when && itName == name){
                      //appendPre(event.summary + " " + when);
                      document.getElementById("modifyName").value = event.summary;
                      document.getElementById("modifyStartDate").value= event.start.date;

                       //日期轉換(天數-1)
                      var dd = parseInt(event.end.date.substr(8,2))-1;
                      var mm = parseInt(event.end.date.substr(5,2));
                      var yy = parseInt(event.end.date.substr(0,4));
                      var eventEndDate = (yy+'-'+mm+'-'+dd);
     
                      document.getElementById("modifyEndDate").value = eventEndDate;
                      document.getElementById("modifyLocation").value=event.location;
                      i = events.length + 1;

                      $('#searchDiv').dialog('close');
                      $('#modifyDiv').dialog('open');

                    }else if (i == events.length-1){
                      alert("Can't find the event");
                    }
                  }
                }

            });
          }

      }

    /*編輯事件*/
    function modifyEvent(){
      var eventName = document.getElementById("modifyName").value;
      var eventStartDate = document.getElementById("modifyStartDate").value;
      var eventEndDate = document.getElementById("modifyEndDate").value;
      //日期轉換(天數+1)
      var dd = parseInt(eventEndDate.substr(8,2))+1;
      var mm = parseInt(eventEndDate.substr(5,2));
      var yy = parseInt(eventEndDate.substr(0,4));
      var eventEndDate = (yy+'-'+mm+'-'+dd);
      
      var eventLocation = document.getElementById("modifyLocation").value;
      var searchName= document.getElementById("searchName").value;
      var searchStartDate= document.getElementById("searchStartDate").value;
      if((eventName == "") || (eventStartDate == "") || (eventEndDate == "") || (eventLocation == "")){
        alert("Error!有未輸入的欄位");

      }else{
        var event = {
          'calendarId': 'primary',
          'location':eventLocation,
          'start': {
          'date': eventStartDate
          },
          'end': {
          'date': eventEndDate
          }
        };
        var request = gapi.client.calendar.events.list({
              'calendarId': 'primary',
              'timeMin': (new Date()).toISOString(),
              'singleEvents': true,
              'maxResults': 10,
              'orderBy': 'startTime'
            });
        request.execute(function(resp) {
            var events = resp.items;
            var i = 0;
              if (events.length > 0) {
                for (i = 0; i < events.length; i++) {
                  var event = events[i];
                 if(searchName == event.summary && searchStartDate == event.start.date){
                    var id = event.id;
                    event.summary = eventName;
                    event.start.date = eventStartDate;
                    event.end.date = eventEndDate;
                    event.location = eventLocation;
                    i = events.length + 1;
                  }
                }
              }
            var updateevent = gapi.client.calendar.events.update({
                'calendarId': 'primary',
                'eventId': id,
                'resource': event
            });

           updateevent.execute(function(event) {
            alert("更新完畢");
            myrefresh();
            $('#modifyDiv').dialog('close');
          });
        });

      }

    }


    /*登出帳號*/
    function signOut() {
      alert('觸發signout()');
      window.location.replace("https://accounts.google.com/logout");
      //window.location.replace("login.html");

    }

    /*更改狀態為是否可修改*/
    function ChangeDisabled(value){
    　if(value=='1'){
        alert("開啟編輯模式");
        $('#modifySitu').html("可編輯");
        $('#ensure_Dbutton').show();
        $('#modify_Dbutton').hide();
    　  document.getElementById('modifyName').disabled = false;　// 變更欄位為可用
        document.getElementById('modifyStartDate').disabled = false;
        document.getElementById('modifyEndDate').disabled = false;　
        document.getElementById('modifyLocation').disabled = false;　　
    　}else{
        $('#modifySitu').html("鎖定");
        $('#ensure_Dbutton').hide();
        $('#modify_Dbutton').show();
    　  document.getElementById('modifyName').disabled = true;　// 變更欄位為禁用
        document.getElementById('modifyStartDate').disabled = true;
        document.getElementById('modifyEndDate').disabled = true;　
        document.getElementById('modifyLocation').disabled = true;　　
    　}
    }

    function showUserName(){
        var request = gapi.client.calendar.events.list({
          'calendarId': 'primary',
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        });

        request.execute(function(resp) {
          var events = resp.items;
          var userName = events[0].organizer.displayName;
          $('#userName').html('&nbsp' + userName);
         });
     }


    </script>

    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>



</head>

<body>
  <div id="insertDiv" class="buttonDiv" title="輸入事件" style="position: relative; z-index: 99; display:none">
    <p>
         <label for="insertName">事件名稱：</label>
         <input type="text" class="text" id="insertName" class="eventName required"  placeholder="請輸入事件名稱" clientidmode="Static">
         <span class="star">*</span>
    </p>

    <p>
         <label for="insertStartDate">事件開始日期：</label>
         <input type="date" class="date" id="insertStartDate" class="eventStartDate" clientidmode="Static">
         <span class="star">*</span>
    </p>

     <p>
         <label for="insertEndDate" >事件結束日期：</label>
         <input type="date" class="date" id="insertEndDate" class="eventEndDate" clientidmode="Static">
         <span class="star">*</span>
    </p>

    <p>
         <label for="insertLocation">事件地點：</label>
         <input type="text" class="text" id="insertLocation" class="eventLocation" clientidmode="Static" oninput="locationCheck('#insertLocation')">
         <span class="star">*</span>
    </p>

    <hr id="hr_line" color="#fff" size="3"/>
       <button type="button" class="btn btn-info btn-lm" class="cancel_Dbutton" style="float: right; margin:0px 3px"onclick="cancelEvent('#insertDiv')">取消</button>
      <button type="button" class="btn btn-info btn-lm" id="insert_Dbutton" style="float: right; margin:0px 3px" onclick="insertEvent()">提交</button>

  </div>


   <div id="deleteDiv" class="buttonDiv" title="刪除事件" style="position: relative; z-index: 99; display:none">
      <p>
           <label for="deleteName">事件名稱：</label>
           <input type="text" class="text" id="deleteName" placeholder="請輸入事件名稱" class="eventName" clientidmode="Static">
           <span class="star">*</span>
      </p>

      <p>
           <label for="deleteStartDate">事件開始日期：</label>
           <input type="date" class="date" id="deleteStartDate" class="eventStartDate" clientidmode="Static">
           <span class="star">*</span>
      </p>

      <hr id="hr_line" color="#fff" size="3"/>
         <button type="button" class="btn btn-info btn-lm" class="cancel_Dbutton" style="float: right; margin:0px 3px"onclick="cancelEvent('#deleteDiv')">取消</button>
        <button type="button" class="btn btn-info btn-lm" id="delete_Dbutton" style="float: right; margin:0px 3px" onclick="deleteEvent()">刪除</button>

    </div>

    <div id="ensureDiv">
          <p>是否確定要刪除?</p>
          <button type="button" class="btn btn-info btn-lm" id="delete_Ebutton" style="float: right; margin:0px 3px" onclick="cancelEvent('#ensureDiv')">取消</button>
          <button type="button" class="btn btn-info btn-lm" class="cancel_button" id="confirm_Ebutton" style="float: right; margin:0px 3px">確定</button>

    </div>


  <div id="modifyDiv" class="buttonDiv" title="事件列表" style="position: relative; z-index: 99">
    <p>
         <label for="modifyName">事件名稱：</label>
         <input type="text" class="text" id="modifyName" class="eventName required"  title="請輸入事件名稱" clientidmode="Static">
         <span class="star">*</span>
    </p>

    <p>
         <label for="modifyStartDate">事件開始日期：</label>
         <input type="date" class="date" id="modifyStartDate" class="eventStartDate" clientidmode="Static">
         <span class="star">*</span>
    </p>

     <p>
         <label for="modifyEndDate">事件結束日期：</label>
         <input type="date" class="date" id="modifyEndDate" class="eventEndDate" clientidmode="Static">
         <span class="star">*</span>
    </p>

    <p>
         <label for="modifyLocation">事件地點：</label>
         <input type="text" class="text" id="modifyLocation" class="eventLocation" clientidmode="Static" oninput="locationCheck('modifyLocation')">
         <span class="star">*</span>
    </p>

    <hr id="hr_line" color="#fff" size="3"/>
      <label id="modifySitu" style="color:red">鎖定狀態</label>
      <button type="button" class="btn btn-info btn-lm" class="cancel_button" style="float: right; margin:0px 3px"onclick="cancelEvent('#modifyDiv')">取消</button>
      <button type="button" class="btn btn-info btn-lm" id="modify_Dbutton" style="float: right; margin:0px 3px" onclick="ChangeDisabled('1')">編輯</button>
      <button type="button" class="btn btn-info btn-lm" id="ensure_Dbutton" style="float: right; margin:0px 3px ; display:none" onclick="modifyEvent()">確定</button>


  </div>


      <!--<div id="search">
        <input type="date" id="searchDate" class="eventStartDate">
        <button id="search_button" class="btn btn-info" onclick="search()" > search </button>
        <pre id="output"></pre>
      </div>-->



  <div id="searchDiv" class="buttonDiv" title="搜尋事件" style="position: relative; z-index: 99; display:none">
  
    <p>
         <label for="searchName">事件名稱：</label>
         <input  type="text" class="text" id="searchName" class="eventStartDate" clientidmode="Static">
         <span class="star">*</span>
         <label for="searchStartDate">事件開始日期：</label>
         <input type="date" class="date" id="searchStartDate" class="eventStartDate" clientidmode="Static">
         <span class="star">*</span>
    </p>

  

    <hr id="hr_line" color="#fff" size="3"/>
       <button type="button" class="btn btn-info btn-lm" class="cancel_button" style="float: right; margin:0px 3px"onclick="cancelEvent('#searchDiv')">取消</button>
      <button type="button" class="btn btn-info btn-lm" id="search_Sbutton" style="float: right; margin:0px 3px" onclick="searchEvent(),ChangeDisabled('2')">提交</button>

  </div>





  <nav class="navbar navbar-inverse navbar-fixed-top" style="font-size:18px" >
    <div class="container-fluid">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="login.html">Guider</a>
      </div>

      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

        <ul class="nav navbar-nav">
          <li class="active"><a href="#">事件列表<span class="sr-only">(current)</span></a></li>
          <li><a href="map.html">地圖導航</a></li>

        </ul>
        <ul class="nav navbar-nav navbar-right">
              <li><a href="#"><span class="glyphicon glyphicon-user" aria-hidden="true"></span><d id="userName">&nbsp;Name</d></a></li>
              <li><a href="https://www.facebook.com/groups/747200725393872/"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>&nbsp;聯絡我們</a></li>
              <li><a href="#" onclick="signOut()"><span class="glyphicon glyphicon-log-out" aria-hidden="true"></span>&nbsp;登出</a></li>

         </ul>


      </div>
  </nav>


  <div id="event_div" class="container-fluid">

            <div id="event_header">
                   Upcoming events:
            </div>
            <hr/>
            <div id="event_content">

            </div>
            <footer id="event_footer">
                <hr>
                <button type="button" class="btn btn-primary btn-lg" id="insert_button">新增事件</button>
                <button type="button" class="btn btn-primary btn-lg" id="delete_button">刪除事件</button>
                <button type="button" class="btn btn-primary btn-lg" id="search_button">搜尋事件</button>
           </footer>
  </div>



      <script src="https://www.google-analytics.com/urchin.js" type="text/javascript">
      </script>

      <meta http-equiv="content-type" content="text/html charse=utf-8">
      <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">


  </body>

</html>
