<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" herf="text/css" href="mapCss.css">
  <title>Map</title>
  <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script src="js/jquery-3.1.1.js"></script>
  <script src="js/bootstrap.js"></script>
  <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyAqZmBR0L326jweeAj84JiwM54stfvbOIE&signed_in=true&libraries=drawing,places"></script>
  <script type="text/javascript" src="js/map.js"></script>
  <script type="text/javascript" src="js/position.js"></script>
  <script type="text/javascript" src="js/direction.js"></script>
  <script type="text/javascript" src="js/road.js"></script>
  <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
  <script language="JavaScript" type="text/javascript">

    var posArr = [];
    var isFindCurPos =false;
    function initialize() {
        initMap();
        initDirection();
        intiRoad();
        getCurrentPosition();
        var timer = setInterval(function(){
          getCurrentPosition();
          getPositionId(g_currentPos);
          g_marker.setVisible(true);
          g_marker.setPosition(g_currentPos);
          if(!isFindCurPos && g_currentPos!=null){
            showInfo(g_currentPos,'Current Location');
            isFindCurPos=true;
          }
          var latlng = {lat:g_currentPos.lat, lng:g_currentPos.lng};
          posArr.push(latlng);}, 500);

        var routeTimer = setInterval(function(){
          //runSnapToRoad(posArr);
          posArr = [];
          if(isRouting){
            calcRoute();
            getRoute();
            g_map.setCenter(g_currentPos);
        }}, 1000);

		    setTimeout(function() {g_map.setCenter(g_currentPos);}, 250);

		   // checkAuth();
     }

    var isRouting = false;
    function route(){
       isRouting=!isRouting;
    }

	//---------------------
	//Calendar
	//---------------------
    var CLIENT_ID = '1032454829565-mq9a352elo3m505k6eqmp79114brc1lp.apps.googleusercontent.com';
    var KEY = '2OTAi0eufTVRWhCrKB2wivpy';
    var SCOPES = ["https://www.googleapis.com/auth/calendar"];
    function checkAuth() {
      gapi.auth.authorize({
        'client_id': CLIENT_ID,
        'scope': SCOPES.join(' '),
        'immediate': true}
		,loadCalendarApi);
    }
    function loadCalendarApi() {
      gapi.client.load('calendar', 'v3', getTodayEventsAndUserName);
    }
    function signOut() {
      window.location.replace("https://accounts.google.com/logout");
      //window.location.replace("login.html");
    }
    function eventGuide(name,location){
      $("#eventText").attr("value", name);
      document.getElementById('end').value = location;
      route();
    }
    function removeAllSpace(str) {
      return str.replace(/\s+/g, "_");
    }
    function displayText(name){
       $("#eventText").attr("value", name);
    }
    function getTodayEventsAndUserName(){
      var request = gapi.client.calendar.events.list({
        'calendarId': 'primary',
        'timeMin': (new Date()).toISOString(),
        'showDeleted': false,
        'singleEvents': true,
        'maxResults': 10,
        'orderBy': 'startTime'
      });
      request.execute(function(resp) {
              var events = resp.items;

              var post = -1 //符合事件數量
              var Today = new Date();
              var yy = Today.getFullYear();
              var mm = Today.getMonth()+1;
              var dd = Today.getDate();
              var itDate = (yy + '-' + mm + '-'+ dd);
               if(dd < 10){
                 dd = '0'+ dd;
               };

               if(mm < 10){
                  mm = '0' + mm;
               }
           
               itDate = (yy + '-' + mm + '-'+ dd);   
	      
              if (events.length > 0) {
			  //getname
			    var userName = events[0].organizer.displayName;
			    $('#userName').html('&nbsp' + userName);
                for (i = 0; i < events.length; i++) {
                  var event = events[i];
                  //var when = event.start.dateTime;
                  var when = event.start.date;
                  var name = event.summary;
                  var trimname = removeAllSpace(name);
                 if(itDate == when){
                     $('#menu').append("<li><a href='#' title='" + name + "'onclick= eventGuide('"+ trimname + "','" + event.location + "')>" + event.summary + "</a></li>");
                     post++;
                  }
                }
                if(post == -1){
                     $('#menu').html("<li>沒有事件</li>");
                }

              }else{
                  $('#menu').html("<li>沒有事件</li>");
              }

      });
   }
   function buttonClick(){
      var value = document.getElementById('end').value;
      eventGuide('未選擇行程',value);
   }
   </script>
  <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>
</head>

<body onload="initialize()">
  <input type="text" id="end"  placeholder="Destination location"/><br />
    <input type="button" value="導航" onclick="buttonClick()" id="direction"/>
       <nav class="navbar navbar-inverse navbar-fixed-top" style="font-size:18px" >
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="login.html">Guider</a>
          </div>

          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

            <ul class="nav navbar-nav">
              <li><a href="event.html">事件列表<span class="sr-only">(current)</span></a></li>
              <li class="active"><a href="#">地圖導航</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#"><span class="glyphicon glyphicon-user" aria-hidden="true"></span><d id="userName">&nbsp;Name</d></a></li>
                <li><a href="https://www.facebook.com/groups/390242997977453/"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>&nbsp;聯絡我們</a></li>
                <li><a href="#" onclick="signOut()"><span class="glyphicon glyphicon-log-out" aria-hidden="true"></span>&nbsp;登出</a></li>
            </ul>

          </div>
      </nav>

  <div class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="false">&times;</span></button>
          <h4 class="modal-title">This</h4>
        </div>
        <div class="modal-body">
          <p>One fine body&hellip;</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>


  <div id="Event_DdM">
    <div class="btn-group">
      <button type="button" class="btn btn-primary">請選擇今日行程</button>
      <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
        <span class="caret"></span>
        <span class="sr-only">Toggle Dropdown</span>
      </button>
      <ul id="menu" class="dropdown-menu" role="menu">
        <!--填寫事件-->
      </ul>
    </div>

    <input type="text" id="eventText" value="尚未選取今日行程" readonly/>
  </div>
  <div id="map"></div>

  <script src="https://www.google-analytics.com/urchin.js" type="text/javascript">
  </script>

  <meta http-equiv="content-type" content="text/html charse=utf-8">
  <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">

  </body>

</html>
