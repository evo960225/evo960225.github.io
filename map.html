<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="stylesheet" herf="text/css" href="mapCss.css">
  <title>Maps</title>
  <script src="js/jquery-3.1.0.js"></script>
  <link rel="stylesheet" type="text/css" href="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" />
  <script src="js/bootstrap.js"></script>
  <script type="text/javascript" src="https://maps.google.com/maps/api/js?key=AIzaSyAqZmBR0L326jweeAj84JiwM54stfvbOIE&signed_in=true&libraries=places"></script>
  <link rel="shortcut icon" type="image/x-icon" href="img/favicon.ico">
  <script type="text/javascript" src="js/mix_main.js"></script>
   <script language="JavaScript" type="text/javascript">
    /*function resizeImage()
    {
      var window_height = document.body.clientHeight
      var window_width = document.body.clientWidth
      var image_width = document.images[0].width
      var image_height = document.images[0].height
      var height_ratio = image_height / window_height
      var width_ratio = image_width / window_width
      if (height_ratio > width_ratio)
      {
      document.images[0].style.width = "auto"
      document.images[0].style.height = "100%"
      }
      else
      {
      document.images[0].style.width = "100%"
      document.images[0].style.height = "auto"
      }
    }*/

    var CLIENT_ID = '1032454829565-mq9a352elo3m505k6eqmp79114brc1lp.apps.googleusercontent.com';
    var KEY = '2OTAi0eufTVRWhCrKB2wivpy';
    var SCOPES = ["https://www.googleapis.com/auth/calendar"];

    function checkAuth() {
      //gapi.client.init({apiKey:'AIzaSyDMky4gQFhabfz4SoxuMkLAuIq2xpOy-WA'});
      //gapi.client.setApiKey(KEY);
       gapi.auth.authorize(
         {
           'client_id': CLIENT_ID,
            'scope': SCOPES.join(' '),
            'immediate': true
          },loadCalendarApi);
        showUserName();

    }

    function loadCalendarApi() {
      //gapi.client.load('calendar', 'v3', showUserName);
      gapi.client.load('calendar', 'v3', listTodayEvents);


    }


    function signOut() {
      alert('觸發signout()');
      window.location.replace("https://accounts.google.com/logout");
      //window.location.replace("login.html");
     
    }



    function showUserName(){
       var request = gapi.client.calendar.events.list({
            'calendarId': 'primary',
        });

        request.execute(function(resp) {
          var events = resp.items;
          var userName = events[0].organizer.displayName;
          $('#userName').html('&nbsp' + userName);
         });
   }


   function eventGuide(name,location){
      $("#eventText").attr("value", name);
      document.getElementById('end').value = location;
      calcRoute();
   }

   function listTodayEvents(){
     var request = gapi.client.calendar.events.list({
        'calendarId': 'primary',
        'timeMin': (new Date()).toISOString(),
        'showDeleted': false,
        'singleEvents': true,
        'maxResults': 10,
        'orderBy': 'startTime'
      });

      showUserName();

      request.execute(function(resp) {
              var events = resp.items;
              var Today = new Date();
              var y = Today.getFullYear();
              var m = Today.getMonth()+1;
              var d = Today.getDate();
              var itDate = (y+'-'+m+'-'+ d); 
              if (events.length > 0) {
                for (i = 0; i < events.length; i++) {
                  var event = events[i];
                  //var when = event.start.dateTime;
                  var when = event.start.date;
                  var name = event.summary;

                  if(itDate == when){
                     $('#menu').append("<li><a href='#' title='" + name + "'onclick= eventGuide('"+ name + "','" + event.location + "')>" + event.summary + "</a></li>");
                  }else if(i == events.length-1){
                    $('#menu').html("<li>Can't find the event</li>");
                  }

                }
              }

          });

   }


   function buttonClick(){
      var value = document.getElementById('end').value;
      eventGuide('未選擇行程',value);
   }




    </script>
    <script src="https://apis.google.com/js/client.js?onload=checkAuth"></script>



</head>

<body onload="initialize()">
	<input type="text" id="end"  placeholder="Destination location"/><br />
    <input type="button" value="導航" onclick="buttonClick()" id="direction"/>
       <nav class="navbar navbar-inverse navbar-fixed-top" style="font-size:18px" >
        <div class="container-fluid">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="login.html">Guider</a>
          </div>

          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

            <ul class="nav navbar-nav">
              <li><a href="event.html">事件列表<span class="sr-only">(current)</span></a></li>
              <li  class="active"><a href="#">地圖導航</a></li>

            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li><a href="#"><span class="glyphicon glyphicon-user" aria-hidden="true"></span><d id="userName">&nbsp;Name</d></a></li>
                <li><a href="https://www.facebook.com/groups/747200725393872/"><span class="glyphicon glyphicon-envelope" aria-hidden="true"></span>&nbsp;聯絡我們</a></li>
                <li><a href="#" onclick="signOut()"><span class="glyphicon glyphicon-log-out" aria-hidden="true"></span>&nbsp;登出</a></li>

             </ul>


          </div>
      </nav>

  <div class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="false">&times;</span></button>
          <h4 class="modal-title">This</h4>
        </div>
        <div class="modal-body">
          <p>One fine body&hellip;</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary">Save changes</button>
        </div>
      </div>
    </div>
  </div>




  <div id="Event_DdM">
    <div class="btn-group">
      <button type="button" class="btn btn-info">請選擇今日行程</button>
      <button type="button" class="btn btn-info dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
        <span class="caret"></span>
        <span class="sr-only">Toggle Dropdown</span>
      </button>
      <ul id="menu" class="dropdown-menu" role="menu">
        <!--填寫事件-->
      </ul>
    </div>

    <input type="text" id="eventText" value="尚未選取今日行程" readonly/>
  </div>
  <div id="map"></div>

  <script src="https://www.google-analytics.com/urchin.js" type="text/javascript">
  </script>

   <meta http-equiv="content-type" content="text/html charse=utf-8">
  <link href="https://netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" rel="stylesheet">




  </body>

</html>
